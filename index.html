<html>
<head>
  <title>Evo</title>
  <script type='text/javascript' src='lib/ivank.js'></script> 
  <script type='text/javascript' src='lib/Box2dWeb-2.1.a.3.min.js'></script> 
  <script type='text/javascript' src='src/ActorBody.js'></script>
  <script type='text/javascript' src='src/Walker.js'></script>
  <script type='text/javascript' src='src/Module.js'></script>
  <script type='text/javascript' src='src/RotationalModule.js'></script>
  <script type='text/javascript' src='src/ModuleButton.js'></script>
  <script type='text/javascript'>
    // Globals
    var world, // The box2d world
        walker, // The player
        moduleButtons   = [],
        MAX_MODULES     = 6,
        b2Vec2          = Box2D.Common.Math.b2Vec2, // The various box2d classes
        b2BodyDef       = Box2D.Dynamics.b2BodyDef, // that we will need.
        b2Body          = Box2D.Dynamics.b2Body,
        b2FixtureDef    = Box2D.Dynamics.b2FixtureDef,
        b2World         = Box2D.Dynamics.b2World,
        b2PolygonShape  = Box2D.Collision.Shapes.b2PolygonShape,
        b2CircleShape   = Box2D.Collision.Shapes.b2CircleShape;

    function Start() {
      var stage = new Stage('c');
      stage.addEventListener(Event.ENTER_FRAME, onEF);
      world = new b2World(new b2Vec2(0, 10), true); // Gravity, doSleep 
      setupGround(stage);
      setupUI(stage);
      setupWalker(stage);
      setupModules(stage);
    }

    function setupGround(stage) {
      var groundBMD = new BitmapData('img/transparent.png');
      var ground = new ActorBody();
      ground.init(groundBMD, 10, 300, 10, 300, b2Body.b2_staticBody, world);
      ground.setDebug(true);
      stage.addChild(ground.getSprite());
    }

    function setupModules(stage) {
      var slothArmBMD = new BitmapData('img/slothArm.png'),
          armModule = new RotationalModule();

      armModule.init(slothArmBMD, 128, 32, 50, 0, b2Body.b2_dynamicBody, world);
      addModuleToButton(armModule, 0);
      armModule.setDebug(true);
      armModule.attachToActorBody(walker, walker.getBody().GetWorldCenter(), world);
      stage.addChild(armModule.getSprite());
   }

    function addModuleToButton(module, index) {
      walker.addModule(module, index); // TODO: I don't think we need modules here
      moduleButtons[index].setModule(module);
    }

    function setupWalker(stage) {
      var slothBMD = new BitmapData('img/sloth.png');

      walker = new Walker();
      walker.init(slothBMD, 64, 64, 32, 32, b2Body.b2_dynamicBody, world);
      walker.setDebug(true);
      stage.addChild(walker.getSprite());
    }

    function setupUI(stage) {
      var buttonBMD = new BitmapData('img/buttonBack.png'),
          buttonBM = new Bitmap(buttonBMD),
          moduleButtonX = (stage.stageWidth / MAX_MODULES + 1),
          moduleButtonXGap = stage.stageWidth / (MAX_MODULES + 1),
          moduleButtonY = stage.stageHeight - 64;

      buttonBM.x = buttonBM.y = -32;

      for(var i = 0; i < MAX_MODULES; i++) {
        moduleButtons[i] = new ModuleButton();
        moduleButtons[i].init(moduleButtonX, moduleButtonY, buttonBM);
        stage.addChild(moduleButtons[i].getSprite());
        moduleButtonX += moduleButtonXGap;
      }
    }

    function moduleButtonPress(e) {
      console.log(e);
      //walker.setModuleActive(e.index, true);
    }

    function onEF() {
      world.Step(1 / 60, 3, 3);
      world.ClearForces();

      walker.update();
    }
  </script>
<head>
<body onload='Start();'>
  <canvas id='c'></canvas>
</body>
</html>
